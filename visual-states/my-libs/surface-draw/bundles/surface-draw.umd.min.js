!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("my-libs/base-geometry")):"function"==typeof define&&define.amd?define("surface-draw",["exports","@angular/core","my-libs/base-geometry"],e):e((t=t||self)["surface-draw"]={},t.ng.core,t["base-geometry"])}(this,(function(t,e,i){"use strict";var n=function(t,e,i,n,o){this.screenPoint=t,this.modelPoint=e,this.surface=i,this.event=n,this.stateEvent=o},o=function(){function t(){this.scale=1,this.offsetX=0,this.offsetY=0,this.width=0,this.height=0,this.switch=!1}return t.prototype.zoomIn=function(){this.scale/=.8},t.prototype.zoomOut=function(){this.scale*=.8},t.prototype.translateXPlus=function(){this.offsetX+=25},t.prototype.translateXMinus=function(){this.offsetX-=25},t.prototype.translateYPlus=function(){this.offsetY+=25},t.prototype.translateYMinus=function(){this.offsetY-=25},t.prototype.invalidate=function(){this.switch=!this.switch},t}(),s=function(){};s.ɵfac=function(t){return new(t||s)},s.ɵprov=e.ɵɵdefineInjectable({token:s,factory:s.ɵfac,providedIn:"root"});Object.create;function h(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}Object.create;var c=["myCanvas"],a=["divElement"],r=function(){function t(){this.scaleValue=1,this.offsetXValue=0,this.offsetYValue=0,this.widthValue=0,this.heightValue=0,this.switchValue=!1,this.drawAxises=!1,this.scaleChange=new e.EventEmitter,this.offsetXChange=new e.EventEmitter,this.offsetYChange=new e.EventEmitter,this.widthChange=new e.EventEmitter,this.heightChange=new e.EventEmitter,this.center=new i.Point(0,0),this.pointerPosition=new i.Point(0,0),this.canvasValid=!1,this.isPan=!1,this.down=new e.EventEmitter,this.move=new e.EventEmitter,this.up=new e.EventEmitter,this.wheelRotate=new e.EventEmitter,this.stateEvent=null}return Object.defineProperty(t.prototype,"scale",{get:function(){return this.scaleValue},set:function(t){this.scaleValue!==t&&(this.scaleValue=t,this.scaleChange.emit(this.scaleValue))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"offsetX",{get:function(){return this.offsetXValue},set:function(t){this.offsetXValue!==t&&(this.offsetXValue=t,this.offsetXChange.emit(this.offsetXValue))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"offsetY",{get:function(){return this.offsetYValue},set:function(t){this.offsetXValue!==t&&(this.offsetYValue=t,this.offsetYChange.emit(this.offsetYValue))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this.widthValue},set:function(t){this.widthValue!==t&&(this.widthValue=t,this.widthChange.emit(this.widthValue))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.heightValue},set:function(t){this.heightValue!==t&&(this.heightValue=t,this.heightChange.emit(this.heightValue))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"switch",{get:function(){return this.switchValue},set:function(t){this.switchValue!==t&&(this.switchValue=t,this.invalidateDrawing())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mousePosition",{get:function(){return this.pointerPosition},enumerable:!1,configurable:!0}),t.prototype.ngOnInit=function(){this.offscreenCanvas=document.createElement("canvas"),this.canvasValid=!0},t.prototype.ngAfterViewInit=function(){var t=this;this.context=this.offscreenCanvas.getContext("2d",{alpha:!1}),window.onresize=this.resizeCanvas.bind(this),requestAnimationFrame((function(){return t.resizeCanvas(t.divElement)}))},t.prototype.resizeCanvas=function(t){var e=this.divElement.nativeElement;this.width=e.clientWidth,this.height=e.clientHeight,this.offscreenCanvas.width=this.width,this.offscreenCanvas.height=this.height,this.canvasRef.nativeElement.width=e.clientWidth,this.canvasRef.nativeElement.height=e.clientHeight,this.invalidateDrawing()},t.prototype.ngOnChanges=function(){this.offscreenCanvas&&(this.context=this.offscreenCanvas.getContext("2d",{alpha:!1}),this.invalidateDrawing())},t.prototype.invalidateDrawing=function(){var t=this;this.canvasValid&&(this.canvasValid=!1,requestAnimationFrame((function(){return t.drawOffscreen()})))},t.prototype.line=function(t,e,i,n,o){void 0===o&&(o="#F3E5F5"),this.context.strokeStyle=o,this.context.beginPath(),this.context.moveTo(this.toDeviceX(t),this.toDeviceY(e)),this.context.lineTo(this.toDeviceX(i),this.toDeviceY(n)),this.context.stroke()},t.prototype.polyline=function(t,e){void 0===e&&(e="#F3E5F5"),this.context.strokeStyle=e,this.context.beginPath();for(var i=0;i<t.length;i++)0===i?this.context.moveTo(this.toDeviceX(t[i].x),this.toDeviceY(t[i].y)):this.context.lineTo(this.toDeviceX(t[i].x),this.toDeviceY(t[i].y));this.context.stroke()},t.prototype.polygon=function(t,e,i){void 0===e&&(e="#F3E5F5"),this.context.strokeStyle=e,this.context.beginPath();for(var n=0;n<t.length;n++)0===n?this.context.moveTo(this.toDeviceX(t[n].x),this.toDeviceY(t[n].y)):this.context.lineTo(this.toDeviceX(t[n].x),this.toDeviceY(t[n].y));if(this.context.closePath(),i){var o=this.context.fillStyle;this.context.fillStyle=i,this.context.fill(),this.context.fillStyle=o}this.context.stroke()},t.prototype.bezierCurve=function(t,e,i,n,o,s,h,c,a){void 0===a&&(a="#F3E5F5"),this.context.strokeStyle=a,this.context.beginPath(),this.context.moveTo(this.toDeviceX(t),this.toDeviceY(e)),this.context.bezierCurveTo(this.toDeviceX(i),this.toDeviceY(n),this.toDeviceX(o),this.toDeviceY(s),this.toDeviceX(h),this.toDeviceY(c)),this.context.stroke()},t.prototype.rect=function(t,e,i,n,o){void 0===o&&(o="#F3E5F5"),this.context.strokeStyle=o;var s=this.toDeviceScale(i),h=this.toDeviceScale(n);this.context.strokeRect(this.toDeviceX(t),this.toDeviceY(e)-h,s,h)},t.prototype.text=function(t,e,i,n,o){void 0===n&&(n=null),void 0===o&&(o="#F3E5F5"),e=this.toDeviceX(e),i=this.toDeviceY(i),this.context.fillStyle="#303030";var s=this.context.font;n&&(this.context.font=n);var h=this.context.measureText(t).width;this.context.fillRect(e-h/2,i-6,h,12),this.context.fillStyle=o,this.context.textBaseline="middle",this.context.textAlign="center",this.context.fillText(t,e,i,h),n&&(this.context.font=s)},t.prototype.image=function(t,e,i,n,o,s){e=this.toDeviceX(e),i=this.toDeviceY(i),n=this.toDeviceScale(n*s),o=this.toDeviceScale(o*s),this.context.drawImage(t,0,0,t.width,t.height,e,i-o,n,o)},t.prototype.fromDeviceScale=function(t){return t/this.scale},t.prototype.toDeviceScale=function(t){return t*this.scale},t.prototype.toDeviceX=function(t){return this.center.x+this.toDeviceScale(this.offsetX)+this.toDeviceScale(t)},t.prototype.toDeviceY=function(t){return this.center.y-this.toDeviceScale(this.offsetY)-this.toDeviceScale(t)},t.prototype.getCenter=function(){var t=this.divElement.nativeElement,e=t.clientWidth/2-t.offsetLeft/2,n=t.clientHeight/2-t.offsetTop/2;return new i.Point(e,n)},t.prototype.drawData=function(){if(this.offscreenCanvas.width>0&&this.offscreenCanvas.height>0){var t=this.canvasRef.nativeElement.getContext("2d",{alpha:!1});t.clearRect(0,0,this.width,this.height),t.drawImage(this.offscreenCanvas,0,0)}},t.prototype.drawOffscreen=function(){var t,e,i,n,o=this;if(!this.canvasValid){if(this.canvasValid=!0,this.center=this.getCenter(),this.context.lineWidth=1,this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.fillStyle="#303030",this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),null!=this.drawItems)try{for(var s=h(this.drawItems),c=s.next();!c.done;c=s.next()){(f=c.value).getLayer()<0&&f.draw(this)}}catch(e){t={error:e}}finally{try{c&&!c.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}if(this.drawGrid(),null!=this.drawItems)try{for(var a=h(this.drawItems),r=a.next();!r.done;r=a.next()){var f;(f=r.value).getLayer()>=0&&f.draw(this)}}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}this.drawVerticalRuler(),this.drawHorizontalRuler(),requestAnimationFrame((function(){return o.drawData()}))}},t.prototype.toLogical=function(t){var e=new i.Point(t.x,t.y);return e.x=this.fromDeviceScale(t.x)-this.offsetX-this.fromDeviceScale(this.center.x),e.y=-(this.fromDeviceScale(t.y-this.center.y)+this.offsetY),e},t.prototype.drawHorizontalRuler=function(){var t=new i.Point(this.center.x,this.center.y);t.x+=this.toDeviceScale(this.offsetX),t.y-=this.toDeviceScale(this.offsetY);for(var e=this.toDeviceScale(10);e<5;)e/=.4;for(;e>15;)e*=.4;this.context.lineWidth=.25,this.context.strokeStyle="#FFFFFF",this.context.beginPath();for(var n=10,o=0,s=t.x;s>=0;s-=e)this.context.moveTo(s,10),this.context.lineTo(s,n+10),o++,10===n?(this.drawRulerText(s,0,!0),o=0,n=5):o>=4&&(n=10);n=5,o=0;for(s=t.x+e;s<=this.context.canvas.width;s+=e)this.context.moveTo(s,10),this.context.lineTo(s,n+10),o++,10===n?(this.drawRulerText(s,0,!0),o=0,n=5):o>=4&&(n=10);this.context.closePath(),this.context.stroke()},t.prototype.drawVerticalRuler=function(){var t=new i.Point(this.center.x,this.center.y);t.x+=this.toDeviceScale(this.offsetX),t.y-=this.toDeviceScale(this.offsetY);for(var e=this.toDeviceScale(10);e<5;)e/=.4;for(;e>15;)e*=.4;this.context.lineWidth=.25,this.context.strokeStyle="#FFFFFF",this.context.beginPath();for(var n=10,o=0,s=t.y;s>=0;s-=e)this.context.moveTo(0,s),this.context.lineTo(n,s),o++,10===n?(this.drawRulerText(12,s,!1),o=0,n=5):o>=4&&(n=10);n=5,o=0;for(s=t.y+e;s<=this.context.canvas.height;s+=e)this.context.moveTo(0,s),this.context.lineTo(n,s),o++,10===n?(this.drawRulerText(12,s,!1),o=0,n=5):o>=4&&(n=10);this.context.closePath(),this.context.stroke()},t.prototype.drawRulerText=function(t,e,n){var o=this.toLogical(new i.Point(t,e)),s=n?Math.round(o.x).toString():Math.round(o.y).toString(),h=this.context.measureText(s).width;this.context.fillStyle="#FFFFFF4A",this.context.textBaseline=n?"top":"middle",this.context.textAlign=n?"center":"start",this.context.fillText(s,t,e,h)},t.prototype.drawGrid=function(){var t=new i.Point(this.center.x,this.center.y);t.x+=this.toDeviceScale(this.offsetX),t.y-=this.toDeviceScale(this.offsetY);for(var e=this.toDeviceScale(10);e<5;)e/=.4;for(;e>15;)e*=.4;this.context.lineWidth=.25,this.context.strokeStyle="#3C3C3C",this.context.setLineDash([4,2]),this.context.beginPath();for(var n=t.x;n>=0;n-=e)this.context.moveTo(n,0),this.context.lineTo(n,this.context.canvas.height);for(n=t.x+e;n<=this.context.canvas.width;n+=e)this.context.moveTo(n,0),this.context.lineTo(n,this.context.canvas.height);for(var o=t.y;o>=0;o-=e)this.context.moveTo(0,o),this.context.lineTo(this.context.canvas.width,o);for(o=t.y+e;o<=this.context.canvas.height;o+=e)this.context.moveTo(0,o),this.context.lineTo(this.context.canvas.width,o);this.context.closePath(),this.context.stroke(),e*=5,this.context.lineWidth=.5,this.context.strokeStyle="#3C3C3C",this.context.beginPath();var s=.5;for(n=t.x;n>=0;n-=e){for(o=t.y;o>=0;o-=e)this.context.strokeRect(n-s,o-s,1,1);for(o=t.y+e;o<=this.context.canvas.height;o+=e)this.context.strokeRect(n-s,o-s,1,1)}for(n=t.x+e;n<=this.context.canvas.width;n+=e){for(o=t.y;o>=0;o-=e)this.context.strokeRect(n-s,o-s,1,1);for(o=t.y+e;o<=this.context.canvas.height;o+=e)this.context.strokeRect(n-s,o-s,1,1)}this.context.closePath(),this.context.stroke(),this.context.setLineDash([]),this.drawAxises&&this.drawCoordinateSystem()},t.prototype.drawCoordinateSystem=function(){var t=this.height-this.divElement.nativeElement.offsetTop;this.context.lineWidth=1,this.context.strokeStyle="#00BFA5",this.context.beginPath(),this.context.moveTo(40,t-40),this.context.lineTo(40,t-140),this.context.lineTo(45,t-135),this.context.lineTo(35,t-135),this.context.lineTo(40,t-140),this.context.stroke(),this.context.lineWidth=1,this.context.strokeStyle="#0091EA",this.context.beginPath(),this.context.moveTo(40,t-40),this.context.lineTo(140,t-40),this.context.lineTo(135,t-35),this.context.lineTo(135,t-45),this.context.lineTo(140,t-40),this.context.stroke()},t.prototype.onMousedown=function(t){if(!this.isPan){var e=new i.Point(t.clientX,t.clientY-this.divElement.nativeElement.offsetTop);this.stateEvent=t;var o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.down.emit(o)}},t.prototype.onMousemove=function(t){if(!this.isPan){var e=new i.Point(t.clientX,t.clientY-this.divElement.nativeElement.offsetTop),o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.pointerPosition=o.modelPoint,this.move.emit(o)}},t.prototype.onMouseup=function(t){if(!this.isPan){var e=new i.Point(t.clientX,t.clientY-this.divElement.nativeElement.offsetTop),o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.up.emit(o),this.stateEvent=t}},t.prototype.onPanStart=function(t){if("touch"===t.pointerType){this.isPan=!0,t.preventDefault(),this.stateEvent=t;var e=new i.Point(t.center.x,t.center.y-this.divElement.nativeElement.offsetTop),o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.down.emit(o)}},t.prototype.onPanMove=function(t){if("touch"===t.pointerType){t.preventDefault();var e=new i.Point(t.center.x,t.center.y-this.divElement.nativeElement.offsetTop),o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.move.emit(o)}},t.prototype.onPanEnd=function(t){if("touch"===t.pointerType){this.isPan=!1,t.preventDefault();var e=new i.Point(t.center.x,t.center.y-this.divElement.nativeElement.offsetTop),o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.up.emit(o),this.stateEvent=t}},t.prototype.onMousewheel=function(t){var e=new i.Point(t.clientX,t.clientY-this.divElement.nativeElement.offsetTop),o=new n(e,this.toLogical(e),this,t,this.stateEvent);this.wheelRotate.emit(o)},t}();r.ɵfac=function(t){return new(t||r)},r.ɵcmp=e.ɵɵdefineComponent({type:r,selectors:[["lib-surface-draw"]],viewQuery:function(t,i){var n;(1&t&&(e.ɵɵstaticViewQuery(c,!0),e.ɵɵstaticViewQuery(a,!0)),2&t)&&(e.ɵɵqueryRefresh(n=e.ɵɵloadQuery())&&(i.canvasRef=n.first),e.ɵɵqueryRefresh(n=e.ɵɵloadQuery())&&(i.divElement=n.first))},hostBindings:function(t,i){1&t&&e.ɵɵlistener("mousedown",(function(t){return i.onMousedown(t)}))("mousemove",(function(t){return i.onMousemove(t)}))("mouseup",(function(t){return i.onMouseup(t)}))("panstart",(function(t){return i.onPanStart(t)}))("panmove",(function(t){return i.onPanMove(t)}))("panend",(function(t){return i.onPanEnd(t)}))("mousewheel",(function(t){return i.onMousewheel(t)}))},inputs:{drawItems:"drawItems",drawAxises:"drawAxises",scale:"scale",offsetX:"offsetX",offsetY:"offsetY",width:"width",height:"height",switch:"switch"},outputs:{scaleChange:"scaleChange",offsetXChange:"offsetXChange",offsetYChange:"offsetYChange",widthChange:"widthChange",heightChange:"heightChange",down:"down",move:"move",up:"up",wheelRotate:"wheelRotate"},features:[e.ɵɵNgOnChangesFeature],decls:4,vars:0,consts:[[1,"div-root"],["divElement",""],[1,"canvas-main"],["myCanvas",""]],template:function(t,i){1&t&&(e.ɵɵelementStart(0,"div",0,1),e.ɵɵelement(2,"canvas",2,3),e.ɵɵelementEnd())},styles:[".canvas-main[_ngcontent-%COMP%] {\n    touch-action: none !important;\n  }\n\n  .div-root[_ngcontent-%COMP%] {\n    position: fixed;\n    width: 100%;\n    height: 100%;\n  }"]});var f=function(){};f.ɵmod=e.ɵɵdefineNgModule({type:f}),f.ɵinj=e.ɵɵdefineInjector({factory:function(t){return new(t||f)},imports:[[]]}),("undefined"==typeof ngJitMode||ngJitMode)&&e.ɵɵsetNgModuleScope(f,{declarations:[r],exports:[r]}),t.SurfaceData=n,t.SurfaceDrawComponent=r,t.SurfaceDrawModule=f,t.SurfaceDrawService=s,t.ViewControl=o,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=surface-draw.umd.min.js.map